"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
exports.parseWindowProperties = parseWindowProperties;
exports.parseWindows = parseWindows;
require("source-map-support/register");
var _lodash = _interopRequireDefault(require("lodash"));
var _utils = require("../utils");
var _driver = require("appium/driver");
const WINDOW_TITLE_PATTERN = /^\s+Window\s#\d+\sWindow\{[0-9a-f]+\s\w+\s([\w-]+)\}:$/;
const FRAME_PATTERN = /\bm?[Ff]rame=\[([0-9.-]+),([0-9.-]+)\]\[([0-9.-]+),([0-9.-]+)\]/;
const VIEW_VISIBILITY_PATTERN = /\bmViewVisibility=(0x[0-9a-fA-F]+)/;
const VIEW_VISIBLE = 0x0;
const STATUS_BAR_WINDOW_NAME_PREFIX = 'StatusBar';
const NAVIGATION_BAR_WINDOW_NAME_PREFIX = 'NavigationBar';
const DEFAULT_WINDOW_PROPERTIES = {
  visible: false,
  x: 0,
  y: 0,
  width: 0,
  height: 0
};
const commands = {};
function parseWindowProperties(name, props, log = null) {
  const result = _lodash.default.cloneDeep(DEFAULT_WINDOW_PROPERTIES);
  const propLines = props.join('\n');
  const frameMatch = FRAME_PATTERN.exec(propLines);
  if (!frameMatch) {
    log === null || log === void 0 ? void 0 : log.debug(propLines);
    throw new Error(`Cannot parse the frame size from '${name}' window properties`);
  }
  result.x = parseFloat(frameMatch[1]);
  result.y = parseFloat(frameMatch[2]);
  result.width = parseFloat(frameMatch[3]) - result.x;
  result.height = parseFloat(frameMatch[4]) - result.y;
  const visibilityMatch = VIEW_VISIBILITY_PATTERN.exec(propLines);
  if (!visibilityMatch) {
    log === null || log === void 0 ? void 0 : log.debug(propLines);
    throw new Error(`Cannot parse the visibility value from '${name}' window properties`);
  }
  result.visible = parseInt(visibilityMatch[1], 16) === VIEW_VISIBLE;
  return result;
}
function parseWindows(lines, log = null) {
  const windows = {};
  let currentWindowName = null;
  for (const line of lines.split('\n').map(_lodash.default.trimEnd)) {
    const match = WINDOW_TITLE_PATTERN.exec(line);
    if (match) {
      currentWindowName = match[1];
      windows[currentWindowName] = [];
      continue;
    }
    if (_lodash.default.trim(line).length === 0) {
      currentWindowName = null;
      continue;
    }
    if (currentWindowName && _lodash.default.isArray(windows[currentWindowName])) {
      windows[currentWindowName].push(line);
    }
  }
  if (_lodash.default.isEmpty(windows)) {
    log === null || log === void 0 ? void 0 : log.debug(lines.join('\n'));
    throw new Error('Cannot parse any window information from the dumpsys output');
  }
  const result = {
    statusBar: null,
    navigationBar: null
  };
  for (const [name, props] of _lodash.default.toPairs(windows)) {
    if (name.startsWith(STATUS_BAR_WINDOW_NAME_PREFIX)) {
      result.statusBar = parseWindowProperties(name, props, log);
    } else if (name.startsWith(NAVIGATION_BAR_WINDOW_NAME_PREFIX)) {
      result.navigationBar = parseWindowProperties(name, props, log);
    }
  }
  const unmatchedWindows = [['statusBar', STATUS_BAR_WINDOW_NAME_PREFIX], ['navigationBar', NAVIGATION_BAR_WINDOW_NAME_PREFIX]].filter(([name]) => _lodash.default.isNil(result[name]));
  for (const [window, namePrefix] of unmatchedWindows) {
    log === null || log === void 0 ? void 0 : log.info(`No windows have been found whose title matches to ` + `'${namePrefix}'. Assuming it is invisible. ` + `Only the following windows are available: ${_lodash.default.keys(windows)}`);
    result[window] = _lodash.default.cloneDeep(DEFAULT_WINDOW_PROPERTIES);
  }
  return result;
}
commands.getSystemBars = async function getSystemBars() {
  let stdout;
  try {
    stdout = await this.adb.shell(['dumpsys', 'window', 'windows']);
  } catch (e) {
    throw new Error(`Cannot retrieve system bars details. Original error: ${e.message}`);
  }
  return parseWindows(stdout, this.log);
};
commands.mobilePerformStatusBarCommand = async function mobilePerformStatusBarCommand(opts = {}) {
  const {
    command
  } = (0, _utils.requireArgs)('command', opts);
  const toStatusBarCommandCallable = (cmd, argsCallable = null) => async () => await this.adb.shell(['cmd', 'statusbar', cmd, ...(argsCallable ? argsCallable() : [])]);
  const tileCommandArgsCallable = () => (0, _utils.requireArgs)('component', opts).component;
  const statusBarCommands = _lodash.default.fromPairs([['expandNotifications', ['expand-notifications']], ['expandSettings', ['expand-settings']], ['collapse', ['collapse']], ['addTile', ['add-tile', tileCommandArgsCallable]], ['removeTile', ['remove-tile', tileCommandArgsCallable]], ['clickTile', ['click-tile', tileCommandArgsCallable]], ['getStatusIcons', ['get-status-icons']]].map(([name, args]) => [name, toStatusBarCommandCallable(...args)]));
  const action = statusBarCommands[command];
  if (!action) {
    throw new _driver.errors.InvalidArgumentError(`The '${command}' status bar command is unknown. Only the following commands ` + `are supported: ${_lodash.default.keys(statusBarCommands)}`);
  }
  return await action();
};
var _default = commands;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbG9kYXNoIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfdXRpbHMiLCJfZHJpdmVyIiwiV0lORE9XX1RJVExFX1BBVFRFUk4iLCJGUkFNRV9QQVRURVJOIiwiVklFV19WSVNJQklMSVRZX1BBVFRFUk4iLCJWSUVXX1ZJU0lCTEUiLCJTVEFUVVNfQkFSX1dJTkRPV19OQU1FX1BSRUZJWCIsIk5BVklHQVRJT05fQkFSX1dJTkRPV19OQU1FX1BSRUZJWCIsIkRFRkFVTFRfV0lORE9XX1BST1BFUlRJRVMiLCJ2aXNpYmxlIiwieCIsInkiLCJ3aWR0aCIsImhlaWdodCIsImNvbW1hbmRzIiwicGFyc2VXaW5kb3dQcm9wZXJ0aWVzIiwibmFtZSIsInByb3BzIiwibG9nIiwicmVzdWx0IiwiXyIsImNsb25lRGVlcCIsInByb3BMaW5lcyIsImpvaW4iLCJmcmFtZU1hdGNoIiwiZXhlYyIsImRlYnVnIiwiRXJyb3IiLCJwYXJzZUZsb2F0IiwidmlzaWJpbGl0eU1hdGNoIiwicGFyc2VJbnQiLCJwYXJzZVdpbmRvd3MiLCJsaW5lcyIsIndpbmRvd3MiLCJjdXJyZW50V2luZG93TmFtZSIsImxpbmUiLCJzcGxpdCIsIm1hcCIsInRyaW1FbmQiLCJtYXRjaCIsInRyaW0iLCJsZW5ndGgiLCJpc0FycmF5IiwicHVzaCIsImlzRW1wdHkiLCJzdGF0dXNCYXIiLCJuYXZpZ2F0aW9uQmFyIiwidG9QYWlycyIsInN0YXJ0c1dpdGgiLCJ1bm1hdGNoZWRXaW5kb3dzIiwiZmlsdGVyIiwiaXNOaWwiLCJ3aW5kb3ciLCJuYW1lUHJlZml4IiwiaW5mbyIsImtleXMiLCJnZXRTeXN0ZW1CYXJzIiwic3Rkb3V0IiwiYWRiIiwic2hlbGwiLCJlIiwibWVzc2FnZSIsIm1vYmlsZVBlcmZvcm1TdGF0dXNCYXJDb21tYW5kIiwib3B0cyIsImNvbW1hbmQiLCJyZXF1aXJlQXJncyIsInRvU3RhdHVzQmFyQ29tbWFuZENhbGxhYmxlIiwiY21kIiwiYXJnc0NhbGxhYmxlIiwidGlsZUNvbW1hbmRBcmdzQ2FsbGFibGUiLCJjb21wb25lbnQiLCJzdGF0dXNCYXJDb21tYW5kcyIsImZyb21QYWlycyIsImFyZ3MiLCJhY3Rpb24iLCJlcnJvcnMiLCJJbnZhbGlkQXJndW1lbnRFcnJvciIsIl9kZWZhdWx0IiwiZXhwb3J0cyIsImRlZmF1bHQiXSwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvY29tbWFuZHMvc3lzdGVtLWJhcnMuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHJlcXVpcmVBcmdzIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnYXBwaXVtL2RyaXZlcic7XG5cbmNvbnN0IFdJTkRPV19USVRMRV9QQVRURVJOID0gL15cXHMrV2luZG93XFxzI1xcZCtcXHNXaW5kb3dcXHtbMC05YS1mXStcXHNcXHcrXFxzKFtcXHctXSspXFx9OiQvO1xuY29uc3QgRlJBTUVfUEFUVEVSTiA9IC9cXGJtP1tGZl1yYW1lPVxcWyhbMC05Li1dKyksKFswLTkuLV0rKVxcXVxcWyhbMC05Li1dKyksKFswLTkuLV0rKVxcXS87XG5jb25zdCBWSUVXX1ZJU0lCSUxJVFlfUEFUVEVSTiA9IC9cXGJtVmlld1Zpc2liaWxpdHk9KDB4WzAtOWEtZkEtRl0rKS87XG4vLyBodHRwczovL2RldmVsb3Blci5hbmRyb2lkLmNvbS9yZWZlcmVuY2UvYW5kcm9pZC92aWV3L1ZpZXcjVklTSUJMRVxuY29uc3QgVklFV19WSVNJQkxFID0gMHgwO1xuY29uc3QgU1RBVFVTX0JBUl9XSU5ET1dfTkFNRV9QUkVGSVggPSAnU3RhdHVzQmFyJztcbmNvbnN0IE5BVklHQVRJT05fQkFSX1dJTkRPV19OQU1FX1BSRUZJWCA9ICdOYXZpZ2F0aW9uQmFyJztcbmNvbnN0IERFRkFVTFRfV0lORE9XX1BST1BFUlRJRVMgPSB7XG4gIHZpc2libGU6IGZhbHNlLFxuICB4OiAwLCB5OiAwLCB3aWR0aDogMCwgaGVpZ2h0OiAwLFxufTtcblxuY29uc3QgY29tbWFuZHMgPSB7fTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBXaW5kb3dQcm9wZXJ0aWVzXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IHZpc2libGUgV2hldGhlciB0aGUgd2luZG93IGlzIHZpc2libGVcbiAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IFdpbmRvdyB4IGNvb3JkaW5hdGVcbiAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5IFdpbmRvdyB5IGNvb3JkaW5hdGVcbiAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3aWR0aCBXaW5kb3cgd2lkdGhcbiAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoZWlnaHQgV2luZG93IGhlaWdodFxuICovXG5cbi8qKlxuICogUGFyc2VzIHdpbmRvdyBwcm9wZXJ0aWVzIGZyb20gYWRiIGR1bXBzeXMgb3V0cHV0XG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHdpbmRvdyB3aG9zZSBwcm9wZXJ0aWVzIGFyZSBiZWluZyBwYXJzZWRcbiAqIEBwYXJhbSB7QXJyYXk8c3RyaW5nPn0gcHJvcHMgVGhlIGxpc3Qgb2YgcGFydGljdWxhciB3aW5kb3cgcHJvcGVydHkgbGluZXMuXG4gKiBDaGVjayB0aGUgY29ycmVzcG9uZGluZyB1bml0IHRlc3RzIGZvciBtb3JlIGRldGFpbHMgb24gdGhlIGlucHV0IGZvcm1hdC5cbiAqIEBwYXJhbSB7T2JqZWN0P30gbG9nIExvZ2dlciBpbnN0YW5jZVxuICogQHJldHVybnMge1dpbmRvd1Byb3BlcnRpZXN9IFBhcnNlZCBwcm9wZXJ0aWVzIG9iamVjdFxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBhbiBpc3N1ZSB3aGlsZSBwYXJzaW5nIHRoZSBwcm9wZXJ0aWVzIHN0cmluZ1xuICovXG5mdW5jdGlvbiBwYXJzZVdpbmRvd1Byb3BlcnRpZXMgKG5hbWUsIHByb3BzLCBsb2cgPSBudWxsKSB7XG4gIGNvbnN0IHJlc3VsdCA9IF8uY2xvbmVEZWVwKERFRkFVTFRfV0lORE9XX1BST1BFUlRJRVMpO1xuICBjb25zdCBwcm9wTGluZXMgPSBwcm9wcy5qb2luKCdcXG4nKTtcbiAgY29uc3QgZnJhbWVNYXRjaCA9IEZSQU1FX1BBVFRFUk4uZXhlYyhwcm9wTGluZXMpO1xuICBpZiAoIWZyYW1lTWF0Y2gpIHtcbiAgICBsb2c/LmRlYnVnKHByb3BMaW5lcyk7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgcGFyc2UgdGhlIGZyYW1lIHNpemUgZnJvbSAnJHtuYW1lfScgd2luZG93IHByb3BlcnRpZXNgKTtcbiAgfVxuICByZXN1bHQueCA9IHBhcnNlRmxvYXQoZnJhbWVNYXRjaFsxXSk7XG4gIHJlc3VsdC55ID0gcGFyc2VGbG9hdChmcmFtZU1hdGNoWzJdKTtcbiAgcmVzdWx0LndpZHRoID0gcGFyc2VGbG9hdChmcmFtZU1hdGNoWzNdKSAtIHJlc3VsdC54O1xuICByZXN1bHQuaGVpZ2h0ID0gcGFyc2VGbG9hdChmcmFtZU1hdGNoWzRdKSAtIHJlc3VsdC55O1xuICBjb25zdCB2aXNpYmlsaXR5TWF0Y2ggPSBWSUVXX1ZJU0lCSUxJVFlfUEFUVEVSTi5leGVjKHByb3BMaW5lcyk7XG4gIGlmICghdmlzaWJpbGl0eU1hdGNoKSB7XG4gICAgbG9nPy5kZWJ1Zyhwcm9wTGluZXMpO1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHBhcnNlIHRoZSB2aXNpYmlsaXR5IHZhbHVlIGZyb20gJyR7bmFtZX0nIHdpbmRvdyBwcm9wZXJ0aWVzYCk7XG4gIH1cbiAgcmVzdWx0LnZpc2libGUgPSBwYXJzZUludCh2aXNpYmlsaXR5TWF0Y2hbMV0sIDE2KSA9PT0gVklFV19WSVNJQkxFO1xuICByZXR1cm4gcmVzdWx0O1xufVxuXG4vKipcbiAqIEV4dHJhY3RzIHN0YXR1cyBhbmQgbmF2aWdhdGlvbiBiYXIgaW5mb3JtYXRpb24gZnJvbSB0aGUgd2luZG93IG1hbmFnZXIgb3V0cHV0LlxuICpcbiAqIEBwYXJhbSB7QXJyYXk8c3RyaW5nPn0gbGluZXMgT3V0cHV0IGZyb20gZHVtcHN5cyBjb21tYW5kLlxuICogQ2hlY2sgdGhlIGNvcnJlc3BvbmRpbmcgdW5pdCB0ZXN0cyBmb3IgbW9yZSBkZXRhaWxzIG9uIHRoZSBpbnB1dCBmb3JtYXQuXG4gKiBAcGFyYW0ge09iamVjdD99IGxvZyBMb2dnZXIgaW5zdGFuY2VcbiAqIEByZXR1cm4ge09iamVjdH0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgdHdvIGl0ZW1zIHdoZXJlIGtleXMgYXJlIHN0YXR1c0JhciBhbmQgbmF2aWdhdGlvbkJhcixcbiAqIGFuZCB2YWx1ZXMgYXJlIGNvcnJlc3BvbmRpbmcgV2luZG93UHJvcGVydGllcyBvYmplY3RzXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgbm8gd2luZG93IHByb3BlcnRpZXMgY291bGQgYmUgcGFyc2VkXG4gKi9cbmZ1bmN0aW9uIHBhcnNlV2luZG93cyAobGluZXMsIGxvZyA9IG51bGwpIHtcbiAgY29uc3Qgd2luZG93cyA9IHt9O1xuICBsZXQgY3VycmVudFdpbmRvd05hbWUgPSBudWxsO1xuICBmb3IgKGNvbnN0IGxpbmUgb2YgbGluZXMuc3BsaXQoJ1xcbicpLm1hcChfLnRyaW1FbmQpKSB7XG4gICAgY29uc3QgbWF0Y2ggPSBXSU5ET1dfVElUTEVfUEFUVEVSTi5leGVjKGxpbmUpO1xuICAgIGlmIChtYXRjaCkge1xuICAgICAgY3VycmVudFdpbmRvd05hbWUgPSBtYXRjaFsxXTtcbiAgICAgIHdpbmRvd3NbY3VycmVudFdpbmRvd05hbWVdID0gW107XG4gICAgICBjb250aW51ZTtcbiAgICB9XG4gICAgaWYgKF8udHJpbShsaW5lKS5sZW5ndGggPT09IDApIHtcbiAgICAgIGN1cnJlbnRXaW5kb3dOYW1lID0gbnVsbDtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGlmIChjdXJyZW50V2luZG93TmFtZSAmJiBfLmlzQXJyYXkod2luZG93c1tjdXJyZW50V2luZG93TmFtZV0pKSB7XG4gICAgICB3aW5kb3dzW2N1cnJlbnRXaW5kb3dOYW1lXS5wdXNoKGxpbmUpO1xuICAgIH1cbiAgfVxuICBpZiAoXy5pc0VtcHR5KHdpbmRvd3MpKSB7XG4gICAgbG9nPy5kZWJ1ZyhsaW5lcy5qb2luKCdcXG4nKSk7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgcGFyc2UgYW55IHdpbmRvdyBpbmZvcm1hdGlvbiBmcm9tIHRoZSBkdW1wc3lzIG91dHB1dCcpO1xuICB9XG5cbiAgY29uc3QgcmVzdWx0ID0ge3N0YXR1c0JhcjogbnVsbCwgbmF2aWdhdGlvbkJhcjogbnVsbH07XG4gIGZvciAoY29uc3QgW25hbWUsIHByb3BzXSBvZiBfLnRvUGFpcnMod2luZG93cykpIHtcbiAgICBpZiAobmFtZS5zdGFydHNXaXRoKFNUQVRVU19CQVJfV0lORE9XX05BTUVfUFJFRklYKSkge1xuICAgICAgcmVzdWx0LnN0YXR1c0JhciA9IHBhcnNlV2luZG93UHJvcGVydGllcyhuYW1lLCBwcm9wcywgbG9nKTtcbiAgICB9IGVsc2UgaWYgKG5hbWUuc3RhcnRzV2l0aChOQVZJR0FUSU9OX0JBUl9XSU5ET1dfTkFNRV9QUkVGSVgpKSB7XG4gICAgICByZXN1bHQubmF2aWdhdGlvbkJhciA9IHBhcnNlV2luZG93UHJvcGVydGllcyhuYW1lLCBwcm9wcywgbG9nKTtcbiAgICB9XG4gIH1cbiAgY29uc3QgdW5tYXRjaGVkV2luZG93cyA9IFtcbiAgICBbJ3N0YXR1c0JhcicsIFNUQVRVU19CQVJfV0lORE9XX05BTUVfUFJFRklYXSxcbiAgICBbJ25hdmlnYXRpb25CYXInLCBOQVZJR0FUSU9OX0JBUl9XSU5ET1dfTkFNRV9QUkVGSVhdXG4gIF0uZmlsdGVyKChbbmFtZV0pID0+IF8uaXNOaWwocmVzdWx0W25hbWVdKSk7XG4gIGZvciAoY29uc3QgW3dpbmRvdywgbmFtZVByZWZpeF0gb2YgdW5tYXRjaGVkV2luZG93cykge1xuICAgIGxvZz8uaW5mbyhgTm8gd2luZG93cyBoYXZlIGJlZW4gZm91bmQgd2hvc2UgdGl0bGUgbWF0Y2hlcyB0byBgICtcbiAgICAgIGAnJHtuYW1lUHJlZml4fScuIEFzc3VtaW5nIGl0IGlzIGludmlzaWJsZS4gYCArXG4gICAgICBgT25seSB0aGUgZm9sbG93aW5nIHdpbmRvd3MgYXJlIGF2YWlsYWJsZTogJHtfLmtleXMod2luZG93cyl9YCk7XG4gICAgcmVzdWx0W3dpbmRvd10gPSBfLmNsb25lRGVlcChERUZBVUxUX1dJTkRPV19QUk9QRVJUSUVTKTtcbiAgfVxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5jb21tYW5kcy5nZXRTeXN0ZW1CYXJzID0gYXN5bmMgZnVuY3Rpb24gZ2V0U3lzdGVtQmFycyAoKSB7XG4gIGxldCBzdGRvdXQ7XG4gIHRyeSB7XG4gICAgc3Rkb3V0ID0gYXdhaXQgdGhpcy5hZGIuc2hlbGwoWydkdW1wc3lzJywgJ3dpbmRvdycsICd3aW5kb3dzJ10pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgcmV0cmlldmUgc3lzdGVtIGJhcnMgZGV0YWlscy4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICB9XG4gIHJldHVybiBwYXJzZVdpbmRvd3Moc3Rkb3V0LCB0aGlzLmxvZyk7XG59O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFN0YXR1c0JhckNvbW1hbmRPcHRpb25zXG4gKiBAcHJvcGVydHkge3N0cmluZ30gY29tbWFuZCBPbmUgb2Ygc3VwcG9ydGVkIHN0YXR1cyBiYXIgY29tbWFuZHM6XG4gKiAtIGV4cGFuZE5vdGlmaWNhdGlvbnM6IE9wZW4gdGhlIG5vdGlmaWNhdGlvbnMgcGFuZWwuXG4gKiAtIGV4cGFuZFNldHRpbmdzOiBPcGVuIHRoZSBub3RpZmljYXRpb25zIHBhbmVsIGFuZCBleHBhbmQgcXVpY2sgc2V0dGluZ3MgaWYgcHJlc2VudC5cbiAqIC0gY29sbGFwc2U6IENvbGxhcHNlIHRoZSBub3RpZmljYXRpb25zIGFuZCBzZXR0aW5ncyBwYW5lbC5cbiAqIC0gYWRkVGlsZTogQWRkIGEgVGlsZVNlcnZpY2Ugb2YgdGhlIHNwZWNpZmllZCBjb21wb25lbnQuXG4gKiAtIHJlbW92ZVRpbGU6IFJlbW92ZSBhIFRpbGVTZXJ2aWNlIG9mIHRoZSBzcGVjaWZpZWQgY29tcG9uZW50LlxuICogLSBjbGlja1RpbGU6IENsaWNrIG9uIGEgVGlsZVNlcnZpY2Ugb2YgdGhlIHNwZWNpZmllZCBjb21wb25lbnQuXG4gKiAtIGdldFN0YXR1c0ljb25zOiBQcmludCB0aGUgbGlzdCBvZiBzdGF0dXMgYmFyIGljb25zIGFuZCB0aGUgb3JkZXIgdGhleSBhcHBlYXIgaW4uXG4gKiBFYWNoIGxpc3QgaXRlbSBpcyBzZXBhcmF0ZWQgd2l0aCBhIG5ldyBsaW5lIGNoYXJhY3Rlci5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nP30gY29tcG9uZW50IFRoZSBuYW1lIG9mIHRoZSB0aWxlIGNvbXBvbmVudC5cbiAqIEl0IGlzIG9ubHkgcmVxdWlyZWQgZm9yIChhZGR8cmVtb3ZlfGNsaWNrKVRpbGUgY29tbWFuZHMuXG4gKiBFeGFtcGxlIHZhbHVlOiBjb20ucGFja2FnZS5uYW1lLy5zZXJ2aWNlLlF1aWNrU2V0dGluZ3NUaWxlQ29tcG9uZW50XG4gKi9cblxuLyoqXG4gKiBQZXJmb3JtcyBjb21tYW5kcyBvbiB0aGUgc3lzdGVtIHN0YXR1cyBiYXIuIEEgdGhpbiB3cmFwcGVyIG92ZXJcbiAqICdhZGIgc2hlbGwgY21kIHN0YXR1c2JhcicgQ0xJLiBXb3JrcyBvbiBBbmRyb2lkIE9yZW8gYW5kIG5ld2VyLlxuICpcbiAqIEBwYXJhbSB7U3RhdHVzQmFyQ29tbWFuZE9wdGlvbnN9IG9wdHNcbiAqIEByZXR1cm5zIHtQcm9taXNlPHN0cmluZz59IFRoZSBhY3R1YWwgb3V0cHV0IG9mIHRoZSBkb3duc3RyZWFtIGNvbnNvbGUgY29tbWFuZC5cbiAqL1xuY29tbWFuZHMubW9iaWxlUGVyZm9ybVN0YXR1c0JhckNvbW1hbmQgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVQZXJmb3JtU3RhdHVzQmFyQ29tbWFuZCAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtjb21tYW5kfSA9IHJlcXVpcmVBcmdzKCdjb21tYW5kJywgb3B0cyk7XG5cbiAgY29uc3QgdG9TdGF0dXNCYXJDb21tYW5kQ2FsbGFibGUgPSAoY21kLCBhcmdzQ2FsbGFibGUgPSBudWxsKSA9PiBhc3luYyAoKSA9PiBhd2FpdCB0aGlzLmFkYi5zaGVsbChbXG4gICAgJ2NtZCcsICdzdGF0dXNiYXInLCBjbWQsIC4uLihhcmdzQ2FsbGFibGUgPyBhcmdzQ2FsbGFibGUoKSA6IFtdKVxuICBdKTtcbiAgY29uc3QgdGlsZUNvbW1hbmRBcmdzQ2FsbGFibGUgPSAoKSA9PiByZXF1aXJlQXJncygnY29tcG9uZW50Jywgb3B0cykuY29tcG9uZW50O1xuICBjb25zdCBzdGF0dXNCYXJDb21tYW5kcyA9IF8uZnJvbVBhaXJzKFtcbiAgICBbJ2V4cGFuZE5vdGlmaWNhdGlvbnMnLCBbJ2V4cGFuZC1ub3RpZmljYXRpb25zJ11dLFxuICAgIFsnZXhwYW5kU2V0dGluZ3MnLCBbJ2V4cGFuZC1zZXR0aW5ncyddXSxcbiAgICBbJ2NvbGxhcHNlJywgWydjb2xsYXBzZSddXSxcbiAgICBbJ2FkZFRpbGUnLCBbJ2FkZC10aWxlJywgdGlsZUNvbW1hbmRBcmdzQ2FsbGFibGVdXSxcbiAgICBbJ3JlbW92ZVRpbGUnLCBbJ3JlbW92ZS10aWxlJywgdGlsZUNvbW1hbmRBcmdzQ2FsbGFibGVdXSxcbiAgICBbJ2NsaWNrVGlsZScsIFsnY2xpY2stdGlsZScsIHRpbGVDb21tYW5kQXJnc0NhbGxhYmxlXV0sXG4gICAgWydnZXRTdGF0dXNJY29ucycsIFsnZ2V0LXN0YXR1cy1pY29ucyddXSxcbiAgXS5tYXAoKFtuYW1lLCBhcmdzXSkgPT4gW25hbWUsIHRvU3RhdHVzQmFyQ29tbWFuZENhbGxhYmxlKC4uLmFyZ3MpXSkpO1xuXG4gIGNvbnN0IGFjdGlvbiA9IHN0YXR1c0JhckNvbW1hbmRzW2NvbW1hbmRdO1xuICBpZiAoIWFjdGlvbikge1xuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEFyZ3VtZW50RXJyb3IoXG4gICAgICBgVGhlICcke2NvbW1hbmR9JyBzdGF0dXMgYmFyIGNvbW1hbmQgaXMgdW5rbm93bi4gT25seSB0aGUgZm9sbG93aW5nIGNvbW1hbmRzIGAgK1xuICAgICAgYGFyZSBzdXBwb3J0ZWQ6ICR7Xy5rZXlzKHN0YXR1c0JhckNvbW1hbmRzKX1gXG4gICAgKTtcbiAgfVxuICByZXR1cm4gYXdhaXQgYWN0aW9uKCk7XG59O1xuXG4vLyBmb3IgdW5pdCB0ZXN0c1xuZXhwb3J0IHsgcGFyc2VXaW5kb3dzLCBwYXJzZVdpbmRvd1Byb3BlcnRpZXMgfTtcbmV4cG9ydCBkZWZhdWx0IGNvbW1hbmRzO1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsSUFBQUEsT0FBQSxHQUFBQyxzQkFBQSxDQUFBQyxPQUFBO0FBQ0EsSUFBQUMsTUFBQSxHQUFBRCxPQUFBO0FBQ0EsSUFBQUUsT0FBQSxHQUFBRixPQUFBO0FBRUEsTUFBTUcsb0JBQW9CLEdBQUcsd0RBQXdEO0FBQ3JGLE1BQU1DLGFBQWEsR0FBRyxpRUFBaUU7QUFDdkYsTUFBTUMsdUJBQXVCLEdBQUcsb0NBQW9DO0FBRXBFLE1BQU1DLFlBQVksR0FBRyxHQUFHO0FBQ3hCLE1BQU1DLDZCQUE2QixHQUFHLFdBQVc7QUFDakQsTUFBTUMsaUNBQWlDLEdBQUcsZUFBZTtBQUN6RCxNQUFNQyx5QkFBeUIsR0FBRztFQUNoQ0MsT0FBTyxFQUFFLEtBQUs7RUFDZEMsQ0FBQyxFQUFFLENBQUM7RUFBRUMsQ0FBQyxFQUFFLENBQUM7RUFBRUMsS0FBSyxFQUFFLENBQUM7RUFBRUMsTUFBTSxFQUFFO0FBQ2hDLENBQUM7QUFFRCxNQUFNQyxRQUFRLEdBQUcsQ0FBQyxDQUFDO0FBcUJuQixTQUFTQyxxQkFBcUJBLENBQUVDLElBQUksRUFBRUMsS0FBSyxFQUFFQyxHQUFHLEdBQUcsSUFBSSxFQUFFO0VBQ3ZELE1BQU1DLE1BQU0sR0FBR0MsZUFBQyxDQUFDQyxTQUFTLENBQUNiLHlCQUF5QixDQUFDO0VBQ3JELE1BQU1jLFNBQVMsR0FBR0wsS0FBSyxDQUFDTSxJQUFJLENBQUMsSUFBSSxDQUFDO0VBQ2xDLE1BQU1DLFVBQVUsR0FBR3JC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